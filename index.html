<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生ペルソナ活用プロンプト生成ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-6 min-h-screen">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                学生ペルソナ活用プロンプト生成ツール
            </h1>
            <p class="text-gray-600 mb-6">
                学生のセルフ・オーサーシップを重視した取り組みやサポートの検討を支援するツール
            </p>
            
            <!-- セルフ・オーサーシップ説明パネル -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-100 mb-6">
                <div class="p-4">
                    <button
                        id="explanationToggle"
                        class="w-full flex items-center justify-between text-left hover:bg-blue-50 rounded-lg p-2 transition-colors"
                        onclick="toggleExplanation()"
                    >
                        <div class="flex items-center">
                            <span class="w-6 h-6 mr-3 text-blue-600 flex items-center justify-center">💡</span>
                            <div>
                                <h3 class="text-lg font-semibold text-blue-800">セルフ・オーサーシップの成長</h3>
                                <p class="text-sm text-blue-600">学生の主体性を重視するこのツールの考え方</p>
                            </div>
                        </div>
                        <span id="explanationIcon" class="text-2xl text-blue-600 transition-transform">▼</span>
                    </button>
                    
                    <div id="explanationContent" class="hidden mt-4 pt-4 border-t border-blue-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- 4つのキーポイント -->
                            <div class="space-y-4">
                                <h4 class="font-semibold text-blue-800 mb-3">キーポイント</h4>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                                        <span class="text-blue-600">🎯</span>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-blue-800">自律性 (Autonomy)</h5>
                                        <p class="text-sm text-blue-700">学生が自ら選択し、決定する権利と能力を尊重する</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                                        <span class="text-green-600">🚀</span>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-blue-800">主体性 (Agency)</h5>
                                        <p class="text-sm text-blue-700">学生が能動的に学習・成長に取り組む姿勢を支援する</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                                        <span class="text-purple-600">⚖️</span>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-blue-800">自己決定権 (Self-Determination)</h5>
                                        <p class="text-sm text-blue-700">学生自身の価値観・目標に基づく選択を最大限尊重する</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                                        <span class="text-yellow-600">⭐</span>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-blue-800">エンパワーメント (Empowerment)</h5>
                                        <p class="text-sm text-blue-700">学生の潜在能力を高め、内発的動機を促進する</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 実践例 -->
                            <div class="space-y-4">
                                <h4 class="font-semibold text-blue-800 mb-3">このツールでの実践</h4>
                                
                                <div class="bg-blue-50 rounded-lg p-3 border border-blue-300">
                                    <h5 class="font-medium text-blue-800 mb-2">✅ セルフ・オーサーシップ重視</h5>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• "学生の内在的な力の成長を後押し"</li>
                                        <li>• 学生の価値観・目標を出発点とした支援</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                                    <h5 class="font-medium text-blue-800 mb-2">🎓 期待される効果</h5>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• 学生の自己理解の深化</li>
                                        <li>• 内発的動機の向上</li>
                                        <li>• 持続可能な成長の実現</li>
                                        <li>• 真の問題解決力の育成</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-100 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <span class="text-blue-600 text-lg">📋</span>
                                <div>
                                    <h5 class="font-medium text-blue-800 mb-1">このツールを使うときの留意点</h5>
                                    <p class="text-sm text-blue-700">
                                        生成されるプロンプトは、学生を「支援される対象」ではなく「成長する主体」として捉え、
                                        一人一人の内在的な力と可能性の成長を後押しするための分析・提案を行います。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- プログレスバー -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-700">設定進捗</h3>
                    <div class="flex items-center space-x-3">
                        <span id="progressPercentage" class="text-sm text-gray-500">0% 完了</span>
                        <button
                            class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors border border-red-200"
                            onclick="clearAllSettings()"
                            title="全ての設定をリセット"
                        >
                            🔄 リセット
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Step 1: ペルソナ読み込み -->
                    <div class="flex-1 flex items-center">
                        <div id="step1" class="flex items-center cursor-pointer" onclick="jumpToStep(1)">
                            <div id="step1Icon" class="w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center mr-2 transition-colors">
                                <span class="text-xs font-semibold text-gray-500">1</span>
                            </div>
                            <div class="hidden sm:block">
                                <div class="text-xs font-medium text-gray-600">ペルソナ</div>
                                <div class="text-xs text-gray-400">読み込み</div>
                            </div>
                        </div>
                        <div id="progress1" class="flex-1 h-2 bg-gray-200 rounded-full mx-2">
                            <div class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Step 2: 課題設定 -->
                    <div class="flex-1 flex items-center">
                        <div id="step2" class="flex items-center cursor-pointer" onclick="jumpToStep(2)">
                            <div id="step2Icon" class="w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center mr-2 transition-colors">
                                <span class="text-xs font-semibold text-gray-500">2</span>
                            </div>
                            <div class="hidden sm:block">
                                <div class="text-xs font-medium text-gray-600">課題</div>
                                <div class="text-xs text-gray-400">設定</div>
                            </div>
                        </div>
                        <div id="progress2" class="flex-1 h-2 bg-gray-200 rounded-full mx-2">
                            <div class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Step 3: フレームワーク選択 -->
                    <div class="flex-1 flex items-center">
                        <div id="step3" class="flex items-center cursor-pointer" onclick="jumpToStep(3)">
                            <div id="step3Icon" class="w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center mr-2 transition-colors">
                                <span class="text-xs font-semibold text-gray-500">3</span>
                            </div>
                            <div class="hidden sm:block">
                                <div class="text-xs font-medium text-gray-600">フレーム</div>
                                <div class="text-xs text-gray-400">ワーク</div>
                            </div>
                        </div>
                        <div id="progress3" class="flex-1 h-2 bg-gray-200 rounded-full mx-2">
                            <div class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Step 4: プロンプト生成 -->
                    <div class="flex items-center">
                        <div id="step4" class="flex items-center cursor-pointer" onclick="jumpToStep(4)">
                            <div id="step4Icon" class="w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center mr-2 transition-colors">
                                <span class="text-xs font-semibold text-gray-500">4</span>
                            </div>
                            <div class="hidden sm:block">
                                <div class="text-xs font-medium text-gray-600">生成</div>
                                <div class="text-xs text-gray-400">完了</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 左側パネル -->
            <div class="space-y-6">
                <!-- 1. CSVアップロード -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span class="w-5 h-5 mr-2 text-blue-600 flex items-center justify-center">📤</span>
                        <h2 class="text-xl font-semibold">1. 学生ペルソナファイル読み込み</h2>
                    </div>
                    <input
                        type="file"
                        id="csvFile"
                        accept=".csv"
                        class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors"
                    />
                    <p class="text-sm text-gray-500 mt-2">
                        最大5名分のペルソナ情報を含むCSVファイルをアップロードしてください<br>
                        <span class="text-xs text-gray-400">必須項目：名前、年齢、学部学科、性格特性、価値観、学習姿勢</span>
                    </p>
                    
                    <!-- エラーメッセージ表示エリア -->
                    <div id="csv-error" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start">
                            <span class="text-red-500 mr-2">⚠️</span>
                            <div>
                                <div class="text-sm font-medium text-red-800">エラー</div>
                                <div id="csv-error-message" class="text-sm text-red-700 whitespace-pre-line"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 読み込み中メッセージ -->
                    <div id="csv-loading" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            <span id="csv-loading-message" class="text-sm text-blue-700"></span>
                        </div>
                    </div>
                    
                    <!-- 成功メッセージ -->
                    <div id="csv-success" class="hidden mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-start">
                            <span class="text-green-500 mr-2">✅</span>
                            <div>
                                <div class="text-sm font-medium text-green-800">成功</div>
                                <div id="csv-success-message" class="text-sm text-green-700"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ペルソナ表示・選択 -->
                <div id="personaSection" class="bg-white rounded-lg shadow-md p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <span class="w-5 h-5 mr-2 text-green-600 flex items-center justify-center">👥</span>
                            <h2 class="text-xl font-semibold">ペルソナ選択</h2>
                            <button
                                class="ml-2 w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs hover:bg-gray-300 transition-colors"
                                onclick="showTooltip('persona-help')"
                                title="ペルソナ選択について"
                            >
                                ?
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="selectionCount" class="text-sm text-gray-600">0名選択中</span>
                            <button
                                id="selectAllBtn"
                                class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-blue-200 transition-colors"
                            >
                                全て選択
                            </button>
                            <button
                                id="clearAllBtn"
                                class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                            >
                                全て解除
                            </button>
                        </div>
                    </div>
                    <div id="personaList" class="space-y-3">
                        <!-- ペルソナリストがここに動的に追加される -->
                    </div>
                </div>

                <!-- 2. 課題設定 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span class="w-5 h-5 mr-2 text-purple-600 flex items-center justify-center">🎯</span>
                        <h2 class="text-xl font-semibold">2. 課題・疑問設定</h2>
                        <button
                            class="ml-2 w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs hover:bg-gray-300 transition-colors"
                            onclick="showTooltip('challenge-help')"
                            title="課題設定について"
                        >
                            ?
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-medium mb-2">学習効果向上系</h3>
                            <div class="space-y-2" id="learningChallenges">
                                <!-- 学習系課題がここに動的に追加される -->
                            </div>
                        </div>

                        <div>
                            <h3 class="font-medium mb-2">学生生活支援系</h3>
                            <div class="space-y-2" id="supportChallenges">
                                <!-- 支援系課題がここに動的に追加される -->
                            </div>
                        </div>

                        <div>
                            <h3 class="font-medium mb-2">カスタム設定</h3>
                            <label class="flex items-center mb-2">
                                <input
                                    type="radio"
                                    name="challenge"
                                    value="custom"
                                    id="customChallenge"
                                    class="mr-2"
                                />
                                <span class="text-sm">自由記述</span>
                            </label>
                            <div class="relative">
                                <textarea
                                    id="customChallengeText"
                                    placeholder="独自の課題・疑問を入力してください（最大500文字）&#10;例：学生が自分自身を学習に向かわせるための仕掛けを作るためにサポートできることは？"
                                    class="w-full p-3 border border-gray-300 rounded-lg resize-none hidden"
                                    rows="4"
                                    maxlength="500"
                                ></textarea>
                                <div id="customChallengeCounter" class="hidden absolute bottom-2 right-2 text-xs text-gray-400">
                                    0/500
                                </div>
                            </div>
                            
                            <!-- カスタム課題のエラーメッセージ -->
                            <div id="challenge-error" class="hidden mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                <div class="flex items-start">
                                    <span class="text-red-500 mr-1 text-sm">⚠️</span>
                                    <div id="challenge-error-message" class="text-sm text-red-700"></div>
                                </div>
                            </div>
                            
                            <!-- カスタム課題の成功メッセージ -->
                            <div id="challenge-success" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded">
                                <div class="flex items-start">
                                    <span class="text-green-500 mr-1 text-sm">✅</span>
                                    <div id="challenge-success-message" class="text-sm text-green-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. フレームワーク選択 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span class="w-5 h-5 mr-2 text-orange-600 flex items-center justify-center">⚙️</span>
                        <h2 class="text-xl font-semibold">3. フレームワーク選択</h2>
                        <button
                            class="ml-2 w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs hover:bg-gray-300 transition-colors"
                            onclick="showTooltip('framework-help')"
                            title="フレームワーク選択について"
                        >
                            ?
                        </button>
                    </div>
                    
                    <div class="space-y-3" id="frameworkList">
                        <!-- フレームワークリストがここに動的に追加される -->
                    </div>
                </div>
            </div>

            <!-- 右側パネル -->
            <div class="space-y-6">
                <!-- エシカルAI使用指針（独立パネル） -->
                <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg shadow-md border border-red-200">
                    <div class="p-4">
                        <button
                            class="w-full flex items-center justify-between text-left hover:bg-red-50 rounded-lg p-2 transition-colors"
                            onclick="toggleStandalonePanel('ethics')"
                        >
                            <div class="flex items-center">
                                <span class="w-6 h-6 mr-3 text-red-600 flex items-center justify-center">⚠️</span>
                                <div>
                                    <h3 class="font-semibold text-red-800">AI使用時の指針</h3>
                                    <p class="text-sm text-red-600">学生の尊厳を保つAI活用の重要な配慮事項</p>
                                </div>
                            </div>
                            <span id="standaloneEthicsIcon" class="text-2xl text-red-600 transition-transform">▼</span>
                        </button>
                        
                        <div id="standaloneEthicsContent" class="hidden mt-4 pt-4 border-t border-red-200">
                            <div class="text-sm text-red-800 mb-4">
                                <strong>学生のセルフ・オーサーシップを尊重し、倫理的にAIを活用するための重要な指針です。</strong>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="bg-white rounded-lg p-3 border border-red-300">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">🛡️</span>学生プライバシーの保護
                                    </h4>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>• 実名や個人を特定できる情報の削除・匿名化</li>
                                        <li>• ペルソナ情報を他の目的で使用しない</li>
                                        <li>• AI分析結果を第三者と共有する際の事前同意</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white rounded-lg p-3 border border-red-300">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">⚖️</span>バイアス・ステレオタイプの回避
                                    </h4>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>• AI分析結果を絶対視せず、批判的に検証する</li>
                                        <li>• 多様な視点からの検討と人間の判断を重視</li>
                                        <li>• 学生を一面的に判断・分類することを避ける</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white rounded-lg p-3 border border-red-300">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">🎓</span>教育現場での配慮
                                    </h4>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>• 分析結果を学生との対話・理解促進の出発点とする</li>
                                        <li>• 学生の自己決定権を尊重し、押し付けを避ける</li>
                                        <li>• 定期的な効果測定と支援方法の見直し</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white rounded-lg p-3 border border-red-300">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">🌟</span>セルフ・オーサーシップの尊重
                                    </h4>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>• 学生を「変える対象」ではなく「成長の主体」として扱う</li>
                                        <li>• 学生の価値観・目標を出発点とした支援</li>
                                        <li>• 内発的動機を高め、自律性を促進する</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-orange-100 rounded border border-orange-300">
                                <p class="text-sm text-orange-800">
                                    <strong>💡 重要：</strong> このツールで生成されるプロンプトは、学生の自己理解と成長を支援するための「対話の出発点」です。
                                    AI分析結果を参考にしながらも、最終的な判断は必ず人間が行い、学生の主体性を最大限尊重してください。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 活用ガイド（独立パネル） -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-md border border-green-200">
                    <div class="p-4">
                        <button
                            class="w-full flex items-center justify-between text-left hover:bg-green-50 rounded-lg p-2 transition-colors"
                            onclick="toggleStandalonePanel('usage')"
                        >
                            <div class="flex items-center">
                                <span class="w-6 h-6 mr-3 text-green-600 flex items-center justify-center">💡</span>
                                <div>
                                    <h3 class="font-semibold text-green-800">活用ガイド</h3>
                                    <p class="text-sm text-green-600">生成されたプロンプトの効果的な使用方法</p>
                                </div>
                            </div>
                            <span id="standaloneUsageIcon" class="text-2xl text-green-600 transition-transform">▼</span>
                        </button>
                        
                        <div id="standaloneUsageContent" class="hidden mt-4 pt-4 border-t border-green-200">
                            <div class="space-y-4">
                                <!-- AI別使用テクニック -->
                                <div class="bg-white rounded-lg p-3 border border-green-300">
                                    <h4 class="font-medium text-green-800 mb-3 flex items-center">
                                        <span class="mr-2">🤖</span>AI別使用テクニック
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                        <div>
                                            <h5 class="font-medium text-green-700 mb-1">🟢 ChatGPT</h5>
                                            <ul class="text-green-600 space-y-1">
                                                <li>• 「詳しく教えて」で深掘り</li>
                                                <li>• 「具体例を挙げて」で実例化</li>
                                                <li>• ファイルアップロード活用</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-green-700 mb-1">🟠 Claude</h5>
                                            <ul class="text-green-600 space-y-1">
                                                <li>• 「系統的に分析して」で整理</li>
                                                <li>• 「図表にして」で可視化</li>
                                                <li>• 複数ファイル同時処理</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-green-700 mb-1">🔵 Gemini</h5>
                                            <ul class="text-green-600 space-y-1">
                                                <li>• 「多角的に検討して」で多面分析</li>
                                                <li>• Google Workspace連携</li>
                                                <li>• リアルタイムデータ参照</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- 効果的なフォローアップ質問 -->
                                <div class="bg-white rounded-lg p-3 border border-green-300">
                                    <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                        <span class="mr-2">💭</span>効果的なフォローアップ質問例
                                    </h4>
                                    <div class="space-y-2 text-sm">
                                        <div>
                                            <h5 class="font-medium text-green-700">深掘り分析</h5>
                                            <p class="text-green-600">「各ペルソナの内発的動機をさらに詳しく分析して」</p>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-green-700">実践化支援</h5>
                                            <p class="text-green-600">「これを実際の授業で使うアクティビティにして」</p>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-green-700">継続改善</h5>
                                            <p class="text-green-600">「この取り組みの効果測定方法は？」</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 教育現場での活用 -->
                                <div class="bg-white rounded-lg p-3 border border-green-300">
                                    <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                        <span class="mr-2">🎓</span>教育現場での活用方法
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div>
                                            <h5 class="font-medium text-green-700">授業・講義</h5>
                                            <ul class="text-green-600 space-y-1">
                                                <li>• ペルソナ分析結果を授業事例に活用</li>
                                                <li>• グループワークのディスカッション題材</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-green-700">個別指導・面談</h5>
                                            <ul class="text-green-600 space-y-1">
                                                <li>• 学生の自己理解促進ツール</li>
                                                <li>• キャリア相談時の参考資料</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-emerald-100 rounded border border-emerald-300">
                                <p class="text-sm text-emerald-800">
                                    <strong>🌟 ポイント：</strong> AI分析結果を「学生を変える材料」ではなく「学生の自己理解・成長を支援する道具」として活用することが重要です。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- プロンプト生成ボタン -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex flex-col space-y-3">
                        <div class="flex items-center mb-4">
                            <span class="w-5 h-5 mr-2 text-blue-600 flex items-center justify-center">🤖</span>
                            <h2 class="text-xl font-semibold">4. プロンプト生成</h2>
                        </div>

                        <!-- プレビューボタン -->
                        <button
                            id="previewBtn"
                            class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 disabled:bg-gray-50 disabled:cursor-not-allowed transition-colors border border-gray-300"
                            disabled
                        >
                            <span class="mr-2">👁️</span>
                            設定内容をプレビュー
                        </button>
                        
                        <!-- 生成ボタン -->
                        <button
                            id="generateBtn"
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                            disabled
                        >
                            <span class="mr-2">✨</span>
                            プロンプト生成
                        </button>
                        
                        <!-- リセットボタン（目立つ位置） -->
                        <button
                            id="mainResetBtn"
                            class="w-full bg-red-50 text-red-600 py-2 px-4 rounded-lg font-medium hover:bg-red-100 transition-colors border border-red-200"
                            onclick="clearAllSettings()"
                        >
                            <span class="mr-2">🔄</span>
                            全設定をリセット
                        </button>
                    </div>
                    
                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="flex items-start">
                            <span class="text-blue-600 mr-2">💡</span>
                            <p class="text-sm text-blue-800">
                                プレビューで設定内容を確認してから生成することをお勧めします。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 生成されたプロンプト -->
                <div id="promptSection" class="bg-white rounded-lg shadow-md p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">生成されたプロンプト</h2>
                        <button
                            id="copyBtn"
                            class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                        >
                            <span class="mr-2">📋</span>
                            コピー
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <pre id="generatedPrompt" class="whitespace-pre-wrap text-sm font-mono"></pre>
                    </div>
                    
                    <!-- 詳細な活用ガイドセクション -->
                    <div class="mt-4 space-y-4">
                        <!-- 基本的な使用方法 -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-start">
                                <span class="w-5 h-5 text-blue-600 mr-2 mt-0.5 flex items-center justify-center">ℹ️</span>
                                <div class="text-sm text-blue-800">
                                    <strong>基本的な使用方法：</strong> 
                                    このプロンプトをChatGPT、Claude、Gemini等の生成AIにコピー＆ペーストしてご利用ください。
                                    学生ペルソナのCSVファイルも一緒にアップロードできるAIサービスの場合は、そちらも併用するとより詳細な分析が可能です。
                                </div>
                            </div>
                        </div>

                        <!-- AI別使用テクニック -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                            <button 
                                class="w-full flex items-center justify-between text-left hover:bg-green-50 rounded-lg p-2 transition-colors" 
                                onclick="toggleUsageGuide('aiTechniques')"
                            >
                                <div class="flex items-center">
                                    <span class="w-6 h-6 mr-3 text-green-600 flex items-center justify-center">🤖</span>
                                    <h3 class="font-semibold text-green-800">AI別使用テクニック</h3>
                                </div>
                                <span id="aiTechniquesIcon" class="text-2xl text-green-600 transition-transform">▼</span>
                            </button>
                            
                            <div id="aiTechniquesContent" class="hidden mt-4 pt-4 border-t border-green-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- ChatGPT -->
                                    <div class="bg-white rounded p-3 border border-green-300">
                                        <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                            <span class="mr-2">🟢</span>ChatGPT
                                        </h4>
                                        <ul class="text-sm text-green-700 space-y-1">
                                            <li>• 「詳しく教えて」で深掘り</li>
                                            <li>• 「具体例を挙げて」で実例化</li>
                                            <li>• 長い分析は段階分けで依頼</li>
                                            <li>• ファイルアップロード活用</li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Claude -->
                                    <div class="bg-white rounded p-3 border border-green-300">
                                        <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                            <span class="mr-2">🟠</span>Claude
                                        </h4>
                                        <ul class="text-sm text-green-700 space-y-1">
                                            <li>• 「系統的に分析して」で整理</li>
                                            <li>• 「図表にして」で可視化</li>
                                            <li>• 長文も一度に処理可能</li>
                                            <li>• 複数ファイル同時処理</li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Gemini -->
                                    <div class="bg-white rounded p-3 border border-green-300">
                                        <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                            <span class="mr-2">🔵</span>Gemini
                                        </h4>
                                        <ul class="text-sm text-green-700 space-y-1">
                                            <li>• 「多角的に検討して」で多面分析</li>
                                            <li>• 「比較して」で差異分析</li>
                                            <li>• Google Workspace連携</li>
                                            <li>• リアルタイムデータ参照</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- フォローアップ質問例 -->
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200">
                            <button 
                                class="w-full flex items-center justify-between text-left hover:bg-purple-50 rounded-lg p-2 transition-colors" 
                                onclick="toggleUsageGuide('followUpQuestions')"
                            >
                                <div class="flex items-center">
                                    <span class="w-6 h-6 mr-3 text-purple-600 flex items-center justify-center">💡</span>
                                    <h3 class="font-semibold text-purple-800">効果的なフォローアップ質問</h3>
                                </div>
                                <span id="followUpQuestionsIcon" class="text-2xl text-purple-600 transition-transform">▼</span>
                            </button>
                            
                            <div id="followUpQuestionsContent" class="hidden mt-4 pt-4 border-t border-purple-200">
                                <div class="space-y-3">
                                    <div class="bg-white rounded p-3 border border-purple-300">
                                        <h4 class="font-medium text-purple-800 mb-2">深掘り分析</h4>
                                        <ul class="text-sm text-purple-700 space-y-1">
                                            <li>• 「各ペルソナの内発的動機をさらに詳しく分析して」</li>
                                            <li>• 「セルフ・オーサーシップが最も促進される支援法は？」</li>
                                            <li>• 「学生が最も自律性を感じる場面を具体化して」</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="bg-white rounded p-3 border border-purple-300">
                                        <h4 class="font-medium text-purple-800 mb-2">実践化支援</h4>
                                        <ul class="text-sm text-purple-700 space-y-1">
                                            <li>• 「これを実際の授業で使うアクティビティにして」</li>
                                            <li>• 「教員向けの実施ガイドラインを作成して」</li>
                                            <li>• 「評価指標・測定方法を提案して」</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="bg-white rounded p-3 border border-purple-300">
                                        <h4 class="font-medium text-purple-800 mb-2">継続改善</h4>
                                        <ul class="text-sm text-purple-700 space-y-1">
                                            <li>• 「この取り組みの効果測定方法は？」</li>
                                            <li>• 「学期中のフォローアップ計画を立てて」</li>
                                            <li>• 「他の学生にも適用する際の注意点は？」</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 教育現場への実装ガイダンス -->
                        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg p-4 border border-yellow-200">
                            <button 
                                class="w-full flex items-center justify-between text-left hover:bg-yellow-50 rounded-lg p-2 transition-colors" 
                                onclick="toggleUsageGuide('implementationGuide')"
                            >
                                <div class="flex items-center">
                                    <span class="w-6 h-6 mr-3 text-yellow-600 flex items-center justify-center">🎓</span>
                                    <h3 class="font-semibold text-yellow-800">教育現場での活用法</h3>
                                </div>
                                <span id="implementationGuideIcon" class="text-2xl text-yellow-600 transition-transform">▼</span>
                            </button>
                            
                            <div id="implementationGuideContent" class="hidden mt-4 pt-4 border-t border-yellow-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-3">
                                        <div class="bg-white rounded p-3 border border-yellow-300">
                                            <h4 class="font-medium text-yellow-800 mb-2">🏫 授業・講義での活用</h4>
                                            <ul class="text-sm text-yellow-700 space-y-1">
                                                <li>• ペルソナ分析結果を授業事例に</li>
                                                <li>• 学生自身の気づき促進材料として</li>
                                                <li>• グループワークのディスカッション題材</li>
                                                <li>• 問題解決型学習（PBL）のケース</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="bg-white rounded p-3 border border-yellow-300">
                                            <h4 class="font-medium text-yellow-800 mb-2">🎯 個別指導・面談</h4>
                                            <ul class="text-sm text-yellow-700 space-y-1">
                                                <li>• 学生の自己理解促進ツール</li>
                                                <li>• キャリア相談時の参考資料</li>
                                                <li>• 学習方法・環境改善の提案根拠</li>
                                                <li>• メンタルサポートの方向性検討</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div class="bg-white rounded p-3 border border-yellow-300">
                                            <h4 class="font-medium text-yellow-800 mb-2">🔄 継続的改善</h4>
                                            <ul class="text-sm text-yellow-700 space-y-1">
                                                <li>• 定期的な効果測定・フィードバック</li>
                                                <li>• 学期ごとの支援方法見直し</li>
                                                <li>• 他教員との情報共有・連携</li>
                                                <li>• 支援効果のデータ蓄積</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="bg-white rounded p-3 border border-yellow-300">
                                            <h4 class="font-medium text-yellow-800 mb-2">⚖️ 倫理的配慮</h4>
                                            <ul class="text-sm text-yellow-700 space-y-1">
                                                <li>• 学生プライバシーの厳重保護</li>
                                                <li>• 偏見・ステレオタイプの回避</li>
                                                <li>• 学生の自主性・選択権の尊重</li>
                                                <li>• 支援の押し付けを避ける</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-amber-100 rounded border border-amber-300">
                                    <h4 class="font-medium text-amber-800 mb-2">🌟 セルフ・オーサーシップ促進のポイント</h4>
                                    <p class="text-sm text-amber-700">
                                        AI分析結果を「学生を変える材料」ではなく「学生の自己理解・成長を支援する道具」として活用することが重要です。
                                        常に学生自身の価値観・目標・選択を出発点とし、内在的動機を高める方向でご利用ください。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- エシカルAI使用指針 -->
                    <div class="mt-4 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg border border-red-200">
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-red-800 flex items-center">
                                    <span class="mr-2">⚠️</span>AI使用時の指針
                                </h3>
                                <button
                                    id="ethicsToggle"
                                    class="text-sm text-red-600 hover:text-red-800 transition-colors"
                                    onclick="toggleEthicsPanel()"
                                >
                                    詳細を表示 ▼
                                </button>
                            </div>
                            
                            <div class="text-sm text-red-700 mb-3">
                                <strong>必須確認:</strong> AIを活用した学生支援において、学生の尊厳と権利を保護するための重要な指針です。
                            </div>

                            <!-- 基本的な注意事項（常に表示） -->
                            <div class="space-y-2 text-sm text-red-700">
                                <div class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2 mt-1.5 flex-shrink-0"></span>
                                    <span>学生の個人情報・プライバシーを最優先に保護する</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2 mt-1.5 flex-shrink-0"></span>
                                    <span>AIの分析結果を絶対的な判断基準としない</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2 mt-1.5 flex-shrink-0"></span>
                                    <span>学生のセルフ・オーサーシップを常に尊重する</span>
                                </div>
                            </div>

                            <!-- 詳細指針（折りたたみ） -->
                            <div id="ethicsDetails" class="hidden mt-4 pt-4 border-t border-red-200">
                                <!-- プライバシー保護 -->
                                <div class="mb-4">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">🔒</span>学生プライバシー保護
                                    </h4>
                                    <div class="bg-white rounded-lg p-3 space-y-2 text-sm text-red-700">
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>実在する学生の氏名・学籍番号等の特定情報は絶対に入力しない</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>分析結果を第三者と共有する際は必ず匿名化処理を行う</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>AIサービスのデータ保持・利用ポリシーを事前に確認する</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>機密性の高い情報は信頼性の確立されたAIサービスのみで使用する</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- バイアス回避 -->
                                <div class="mb-4">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">⚖️</span>バイアス回避ガイドライン
                                    </h4>
                                    <div class="bg-white rounded-lg p-3 space-y-2 text-sm text-red-700">
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>AIの分析結果は参考情報として活用し、最終判断は必ず人間が行う</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>文化的背景・個人的価値観の多様性を尊重し、画一的な評価を避ける</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>複数の視点・アプローチで検証し、偏った解釈を防ぐ</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>学生のラベル化・ステレオタイプ化を厳格に避ける</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 教育現場での配慮 -->
                                <div class="mb-4">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <span class="mr-2">🎓</span>教育現場適用時の配慮事項
                                    </h4>
                                    <div class="bg-white rounded-lg p-3 space-y-2 text-sm text-red-700">
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>学生に対してAI分析を使用していることを必ず開示・同意を得る</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>分析結果を学生評価に直接利用せず、支援のための参考情報とする</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>学生自身の意見・感情・選択を最優先に尊重する</span>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="text-red-500 mr-2">•</span>
                                            <span>支援策実施前に必ず学生本人と対話・合意形成を行う</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- セルフ・オーサーシップ重視 -->
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                                    <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                                        <span class="mr-2">✨</span>セルフ・オーサーシップ最優先原則
                                    </h4>
                                    <div class="text-sm text-blue-700 space-y-1">
                                        <div>• AIはあくまで学生の自律的成長を支援するツールに留める</div>
                                        <div>• 学生の内発的動機と自己決定権を何より重視する</div>
                                        <div>• 「学生のため」ではなく「学生と共に」の姿勢で活用する</div>
                                        <div>• 分析結果は学生自身の自己理解促進のために活用する</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 使用状況表示 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold">設定状況</h3>
                        <div class="flex items-center space-x-2">
                            <!-- 保存状態インジケーター -->
                            <div class="flex items-center">
                                <div id="saveStatus" class="w-2 h-2 rounded-full mr-1 bg-gray-300"></div>
                                <span id="saveStatusText" class="text-xs text-gray-500">未保存</span>
                            </div>
                            <!-- クリアボタン -->
                            <button
                                id="clearSettingsBtn"
                                class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors"
                                onclick="clearAllSettings()"
                                title="全ての設定をクリア"
                            >
                                リセット
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center">
                            <div id="personaStatus" class="w-3 h-3 rounded-full mr-2 bg-gray-300"></div>
                            <span id="personaStatusText">ペルソナファイル: 未読み込み</span>
                        </div>
                        <div class="flex items-center">
                            <div id="selectedStatus" class="w-3 h-3 rounded-full mr-2 bg-gray-300"></div>
                            <span id="selectedStatusText">選択ペルソナ: 0名</span>
                        </div>
                        <div class="flex items-center">
                            <div id="challengeStatus" class="w-3 h-3 rounded-full mr-2 bg-gray-300"></div>
                            <span id="challengeStatusText">課題設定: 未設定</span>
                        </div>
                        <div class="flex items-center">
                            <div id="frameworkStatus" class="w-3 h-3 rounded-full mr-2 bg-gray-300"></div>
                            <span id="frameworkStatusText">フレームワーク: 未選択</span>
                        </div>
                    </div>
                    
                    <!-- 保存機能の説明 -->
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-500 text-xs">💾</span>
                            <p class="text-xs text-gray-600">
                                設定は自動保存されます。ブラウザを閉じても次回開いた際に復元されます。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- プレビューモーダル -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- モーダルヘッダー -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-blue-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="w-8 h-8 mr-3 text-blue-600 flex items-center justify-center">👁️</span>
                        <h2 class="text-xl font-semibold text-blue-800">設定内容プレビュー</h2>
                    </div>
                    <button
                        id="closePreviewBtn"
                        class="w-8 h-8 rounded-full hover:bg-blue-100 flex items-center justify-center text-blue-600 transition-colors"
                        onclick="closePreview()"
                    >
                        ✕
                    </button>
                </div>
                <p class="text-sm text-blue-600 mt-1">生成前に設定内容を確認してください</p>
            </div>
            
            <!-- モーダルコンテンツ -->
            <div class="overflow-y-auto max-h-[calc(90vh-120px)]">
                <div class="p-6 space-y-6">
                    <!-- 設定サマリー -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ペルソナ情報 -->
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <h3 class="font-semibold text-green-800 mb-3 flex items-center">
                                <span class="mr-2">👥</span>選択されたペルソナ
                            </h3>
                            <div id="previewPersonas" class="space-y-2">
                                <!-- ペルソナ情報がここに表示される -->
                            </div>
                        </div>
                        
                        <!-- 課題・フレームワーク -->
                        <div class="space-y-4">
                            <!-- 課題設定 -->
                            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                <h3 class="font-semibold text-purple-800 mb-2 flex items-center">
                                    <span class="mr-2">🎯</span>設定された課題
                                </h3>
                                <div id="previewChallenge" class="text-sm text-purple-700">
                                    <!-- 課題内容がここに表示される -->
                                </div>
                            </div>
                            
                            <!-- フレームワーク -->
                            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                                    <span class="mr-2">⚙️</span>選択フレームワーク
                                </h3>
                                <div id="previewFramework" class="text-sm text-orange-700">
                                    <!-- フレームワーク情報がここに表示される -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- プロンプト概要 -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <span class="mr-2">📋</span>生成されるプロンプトの構造
                        </h3>
                        <div id="previewPromptStructure" class="text-sm text-blue-700 space-y-2">
                            <!-- プロンプト構造がここに表示される -->
                        </div>
                    </div>
                    
                    <!-- セルフ・オーサーシップ確認 -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200">
                        <h3 class="font-semibold text-indigo-800 mb-2 flex items-center">
                            <span class="mr-2">✨</span>セルフ・オーサーシップ重視の分析
                        </h3>
                        <div class="text-sm text-indigo-700 space-y-1">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
                                学生の自律性・主体性を出発点とした分析
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
                                内発的動機を高めるアプローチの提案
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
                                学生の価値観・目標を尊重した支援策
                            </div>
                        </div>
                    </div>

                    <!-- エシカル使用の確認 -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4 border border-red-200">
                        <h3 class="font-semibold text-red-800 mb-3 flex items-center">
                            <span class="mr-2">⚠️</span>AI使用時の注意点の確認
                        </h3>
                        <div class="space-y-3">
                            <div class="text-sm text-red-700">
                                生成されるプロンプトを使用する前に、以下の重要事項を必ず確認してください：
                            </div>
                            
                            <!-- チェックボックス形式の確認項目 -->
                            <div class="space-y-2">
                                <label class="flex items-start text-sm text-red-700 cursor-pointer">
                                    <input type="checkbox" id="ethicsCheck1" class="mt-1 mr-2 text-red-600" />
                                    <span>学生の個人情報・プライバシーを適切に保護します</span>
                                </label>
                                <label class="flex items-start text-sm text-red-700 cursor-pointer">
                                    <input type="checkbox" id="ethicsCheck2" class="mt-1 mr-2 text-red-600" />
                                    <span>AIの分析結果は参考情報として活用し、学生の人格を尊重します</span>
                                </label>
                                <label class="flex items-start text-sm text-red-700 cursor-pointer">
                                    <input type="checkbox" id="ethicsCheck3" class="mt-1 mr-2 text-red-600" />
                                    <span>学生のセルフ・オーサーシップを最優先に考慮します</span>
                                </label>
                                <label class="flex items-start text-sm text-red-700 cursor-pointer">
                                    <input type="checkbox" id="ethicsCheck4" class="mt-1 mr-2 text-red-600" />
                                    <span>支援策は学生との対話・合意を通じて実施します</span>
                                </label>
                            </div>
                            
                            <div class="mt-3 p-2 bg-white rounded border border-red-300">
                                <div class="text-xs text-red-600">
                                    <strong>重要:</strong> 全ての項目への同意が、責任あるAI活用の前提条件です。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- モーダルフッター -->
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button
                        id="cancelPreviewBtn"
                        class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                        onclick="closePreview()"
                    >
                        設定を修正する
                    </button>
                    <button
                        id="confirmGenerateBtn"
                        class="px-6 py-2 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed"
                        disabled
                        onclick="confirmAndGenerate()"
                    >
                        注意点の確認後に生成可能
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let personas = [];
        let selectedPersonas = [];
        let selectedChallenge = '';
        let customChallengeText = '';
        let selectedFramework = '';
        let frameworkSelectionReason = ''; // 選択理由記録用
        let customFrameworkText = ''; // カスタムフレームワーク記録用

        // プリセット課題
        const presetChallenges = {
            learning: [
                '学習モチベーション向上',
                '授業理解度・満足度向上',
                '学習習慣・時間管理改善',
                'デジタル学習環境最適化',
                'アクティブラーニング促進',
                '個別学習支援'
            ],
            support: [
                'キャリア支援・就職活動支援',
                'ウェルビーイング向上',
                '学生コミュニティ形成',
                '経済的支援制度改善',
                '大学生活適応支援',
                '進路選択支援'
            ]
        };

        // フレームワーク選択肢（詳細情報付き）
        const frameworks = [
            {
                id: 'persona_interview',
                name: 'ペルソナ個別インタビュー',
                description: '学生ペルソナに対するインタビュー形式での深掘り',
                applicationScenarios: [
                    '個別の学習課題や悩みを深く理解したい場合',
                    '学生の内面的動機や価値観を探りたい場合',
                    '特定ペルソナの視点から課題を詳細に分析したい場合'
                ],
                expectedEffects: [
                    '学生の心理・動機の理解',
                    '個別ニーズの具体的把握',
                    'パーソナライズされた支援策の発見'
                ],
                autonomyRationale: '学生自身の声・体験を中心とした分析により自己理解を促進',
                recommendedFor: ['個別学習支援', 'ウェルビーイング向上', 'キャリア支援・就職活動支援'],
                combinations: ['共感マップ', 'ステークホルダーマップ']
            },
            {
                id: 'persona_discussion',
                name: 'ペルソナグループディスカッション',
                description: '複数ペルソナによる議論・対話',
                applicationScenarios: [
                    '異なる背景の学生間の相互理解を促進したい場合',
                    '多様な視点から課題解決策を検討したい場合',
                    'コミュニティ形成や協働学習を促進したい場合'
                ],
                expectedEffects: [
                    '多角的な課題理解',
                    '学生間の相互理解促進',
                    '協働的問題解決能力の向上'
                ],
                autonomyRationale: '学生同士の対話・協働を通じて主体的な気づきと成長を促進',
                recommendedFor: ['学生コミュニティ形成', 'アクティブラーニング促進', '大学生活適応支援'],
                combinations: ['エコシステムマップ', 'ステークホルダーマップ']
            },
            {
                id: 'student_journey',
                name: '学生ジャーニーマップ',
                description: '学生の体験・行動・感情の時系列マッピング',
                applicationScenarios: [
                    '学習プロセス全体での課題を把握したい場合',
                    '時期別の支援ニーズを明確化したい場合',
                    '学生の成長段階に応じた支援を設計したい場合'
                ],
                expectedEffects: [
                    '時系列での課題・ニーズの可視化',
                    'タイミングに応じた効果的支援の設計',
                    '学生の成長プロセス全体の理解'
                ],
                autonomyRationale: '学生の自然な成長プロセスを尊重し、適切なタイミングでの支援を重視',
                recommendedFor: ['学習習慣・時間管理改善', '進路選択支援', '大学生活適応支援'],
                combinations: ['共感マップ', 'サービスブループリント']
            },
            {
                id: 'service_blueprint',
                name: 'サービスブループリント',
                description: 'サービス提供プロセスの可視化',
                applicationScenarios: [
                    '教育サービス・支援体制を改善したい場合',
                    '学生と教員・職員の接点を最適化したい場合',
                    'システマティックな支援体制を構築したい場合'
                ],
                expectedEffects: [
                    '支援プロセスの全体最適化',
                    'タッチポイントでの学生体験向上',
                    '効率的で効果的な支援体制の構築'
                ],
                autonomyRationale: 'サービス側の改善により学生の選択肢と自律性を間接的に支援',
                recommendedFor: ['デジタル学習環境最適化', '経済的支援制度改善', 'キャリア支援・就職活動支援'],
                combinations: ['エコシステムマップ', 'ステークホルダーマップ']
            },
            {
                id: 'ecosystem_map',
                name: 'エコシステムマップ',
                description: '学生を取り巻く環境・関係性の全体像',
                applicationScenarios: [
                    '学生の置かれている環境全体を把握したい場合',
                    '関係者間の連携を強化したい場合',
                    'システム全体での課題解決を図りたい場合'
                ],
                expectedEffects: [
                    '環境要因の包括的理解',
                    'ステークホルダー間の連携促進',
                    'システム全体での最適解の発見'
                ],
                autonomyRationale: '学生を取り巻く環境を改善することで自律的な選択・行動を支援',
                recommendedFor: ['学生コミュニティ形成', '経済的支援制度改善', 'ウェルビーイング向上'],
                combinations: ['ステークホルダーマップ', 'サービスブループリント']
            },
            {
                id: 'empathy_map',
                name: '共感マップ',
                description: '学生の感情・認知・行動の詳細分析',
                applicationScenarios: [
                    '学生の感情的ニーズを深く理解したい場合',
                    '認知的負荷や心理的課題を把握したい場合',
                    '共感的支援アプローチを設計したい場合'
                ],
                expectedEffects: [
                    '学生の内面世界の深い理解',
                    '感情に寄り添う支援策の開発',
                    '共感的コミュニケーションの向上'
                ],
                autonomyRationale: '学生の感情・価値観を深く理解し尊重することで自己決定を支援',
                recommendedFor: ['ウェルビーイング向上', '学習モチベーション向上', '個別学習支援'],
                combinations: ['ペルソナ個別インタビュー', '学生ジャーニーマップ']
            }
        ];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            setupEventListeners();
            restoreSettings();
        });

        function initializeUI() {
            // 課題選択肢を生成
            generateChallengeOptions();
            // フレームワーク選択肢を生成
            generateFrameworkOptions();
        }

        function generateChallengeOptions() {
            // 学習効果向上系
            const learningDiv = document.getElementById('learningChallenges');
            presetChallenges.learning.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `
                    <input type="radio" name="challenge" value="${item}" class="mr-2">
                    <span class="text-sm">${item}</span>
                `;
                learningDiv.appendChild(label);
            });

            // 学生生活支援系
            const supportDiv = document.getElementById('supportChallenges');
            presetChallenges.support.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `
                    <input type="radio" name="challenge" value="${item}" class="mr-2">
                    <span class="text-sm">${item}</span>
                `;
                supportDiv.appendChild(label);
            });
        }

        function generateFrameworkOptions() {
            const frameworkDiv = document.getElementById('frameworkList');
            frameworks.forEach(fw => {
                const div = document.createElement('div');
                div.className = 'border rounded-lg transition-colors border-gray-200 hover:border-gray-300';
                
                div.innerHTML = `
                    <div class="p-3 cursor-pointer" onclick="selectFramework('${fw.id}', this.parentElement)">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-medium">${fw.name}</h3>
                                    <span class="w-5 h-5 text-orange-600 hidden">✓</span>
                                </div>
                                <p class="text-sm text-gray-600">${fw.description}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 詳細情報（展開可能） -->
                    <div class="hidden border-t border-gray-200 p-3 bg-gray-50" id="details_${fw.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <h4 class="font-medium text-gray-800 mb-2">🎯 適用場面</h4>
                                <ul class="text-gray-700 space-y-1">
                                    ${fw.applicationScenarios.map(scenario => `<li>• ${scenario}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-2">✨ 期待効果</h4>
                                <ul class="text-gray-700 space-y-1">
                                    ${fw.expectedEffects.map(effect => `<li>• ${effect}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-300">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h4 class="font-medium text-blue-800 mb-2">🌟 セルフ・オーサーシップとの関連</h4>
                                    <p class="text-blue-700">${fw.autonomyRationale}</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-purple-800 mb-2">🔗 推奨組み合わせ</h4>
                                    <p class="text-purple-700">${fw.combinations.join('、')}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex justify-end">
                            <button 
                                class="text-xs text-gray-500 hover:text-gray-700"
                                onclick="toggleFrameworkDetails('${fw.id}')"
                            >
                                詳細を非表示 ▲
                            </button>
                        </div>
                    </div>
                    
                    <!-- 詳細表示ボタン -->
                    <div class="px-3 pb-3">
                        <button 
                            class="text-xs text-blue-600 hover:text-blue-800"
                            onclick="toggleFrameworkDetails('${fw.id}')"
                            id="toggle_${fw.id}"
                        >
                            詳細を表示 ▼
                        </button>
                    </div>
                `;
                
                frameworkDiv.appendChild(div);
            });
            
            // カスタムフレームワーク選択肢を追加
            const customDiv = document.createElement('div');
            customDiv.className = 'border rounded-lg transition-colors border-gray-200 hover:border-gray-300';
            customDiv.innerHTML = `
                <div class="p-3 cursor-pointer" onclick="selectFramework('custom', this.parentElement)">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium">カスタムフレームワーク</h3>
                                <span class="w-5 h-5 text-orange-600 hidden">✓</span>
                            </div>
                            <p class="text-sm text-gray-600">独自の分析手法・アプローチを設定</p>
                        </div>
                    </div>
                </div>
                
                <!-- カスタムフレームワーク入力エリア -->
                <div class="hidden border-t border-gray-200 p-3 bg-gray-50" id="customFrameworkArea">
                    <div class="relative">
                        <textarea
                            id="customFrameworkText"
                            placeholder="使用したいフレームワーク・分析手法を詳しく説明してください（最大300文字）&#10;例：デザインシンキングのプロセスを用いて、学生の課題に対するアイデア創出を行う"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 resize-none text-sm"
                            rows="4"
                            maxlength="300"
                            oninput="updateCustomFrameworkCounter(); validateCustomFramework(this.value);"
                        ></textarea>
                        <div id="customFrameworkCounter" class="absolute bottom-2 right-2 text-xs text-gray-400">0/300</div>
                    </div>
                    
                    <!-- エラー・成功メッセージ -->
                    <div id="framework-error" class="hidden mt-2 p-2 bg-red-50 border border-red-200 rounded">
                        <div class="flex items-start">
                            <span class="w-4 h-4 text-red-600 mr-2 mt-0.5">⚠️</span>
                            <div class="text-sm text-red-700" id="framework-error-message"></div>
                        </div>
                    </div>
                    
                    <div id="framework-success" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded">
                        <div class="flex items-start">
                            <span class="w-4 h-4 text-green-600 mr-2 mt-0.5">✓</span>
                            <div class="text-sm text-green-700" id="framework-success-message"></div>
                        </div>
                    </div>
                </div>
            `;
            frameworkDiv.appendChild(customDiv);
        }

        function setupEventListeners() {
            // CSVファイルアップロード
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
            
            // 課題選択
            document.addEventListener('change', function(e) {
                if (e.target.name === 'challenge') {
                    selectedChallenge = e.target.value;
                    if (e.target.value === 'custom') {
                        document.getElementById('customChallengeText').classList.remove('hidden');
                        document.getElementById('customChallengeCounter').classList.remove('hidden');
                        clearErrorMessage('challenge-error');
                        clearSuccessMessage('challenge-success');
                    } else {
                        document.getElementById('customChallengeText').classList.add('hidden');
                        document.getElementById('customChallengeCounter').classList.add('hidden');
                        clearErrorMessage('challenge-error');
                        clearSuccessMessage('challenge-success');
                    }
                    updateStatus();
                }
            });

            // カスタム課題テキスト
            document.getElementById('customChallengeText').addEventListener('input', function(e) {
                customChallengeText = e.target.value;
                validateCustomChallenge(e.target.value);
                updateCharacterCounter();
                updateStatus();
            });

            // 一括選択ボタン
            document.getElementById('selectAllBtn').addEventListener('click', selectAllPersonas);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllPersonas);

            // プレビューボタン
            document.getElementById('previewBtn').addEventListener('click', showPreview);

            // プロンプト生成ボタン
            document.getElementById('generateBtn').addEventListener('click', generatePrompt);
            
            // コピーボタン
            document.getElementById('copyBtn').addEventListener('click', copyPrompt);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ファイル形式チェック
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showErrorMessage('csv-error', 'CSVファイル（.csv）を選択してください。');
                return;
            }

            // ファイルサイズチェック（5MB制限）
            if (file.size > 5 * 1024 * 1024) {
                showErrorMessage('csv-error', 'ファイルサイズが大きすぎます。5MB以下のファイルを選択してください。');
                return;
            }

            clearErrorMessage('csv-error');
            showLoadingMessage('csv-loading', 'CSVファイルを読み込み中...');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                delimiter: ",",
                quoteChar: '"',
                escapeChar: '"',
                trimHeaders: true,
                transform: function(value) {
                    // 前後の空白を削除し、ダブルクオーテーションも適切に処理
                    return typeof value === 'string' ? value.trim() : value;
                },
                complete: function(results) {
                    try {
                        clearLoadingMessage('csv-loading');
                        
                        if (results.errors && results.errors.length > 0) {
                            showErrorMessage('csv-error', 'CSVファイルの形式に問題があります。文字化けや区切り文字を確認してください。');
                            return;
                        }

                        const validationResult = validateCSVData(results.data);
                        if (!validationResult.isValid) {
                            showErrorMessage('csv-error', validationResult.message);
                            return;
                        }

                        personas = validationResult.personas;
                        selectedPersonas = [];
                        displayPersonas();
                        updateStatus();
                        showSuccessMessage('csv-success', `${personas.length}名のペルソナが正常に読み込まれました。`);
                    } catch (error) {
                        clearLoadingMessage('csv-loading');
                        showErrorMessage('csv-error', 'CSVファイルの読み込みに失敗しました。ファイル形式を確認してください。');
                    }
                },
                error: function(error) {
                    clearLoadingMessage('csv-loading');
                    showErrorMessage('csv-error', `CSVファイルの読み込みに失敗しました：${error.message}`);
                }
            });
        }

        function validateCSVData(data) {
            const requiredFields = ['名前', '年齢', '学部学科', '性格特性', '価値観', '学習姿勢'];
            const optionalFields = ['出身地', '居住形態', '経済状況', '人間関係', '主な課題', '成長の兆し', '特徴的エピソード', '支援アプローチ'];
            
            // 空行除去
            const filteredData = data.filter(row => 
                Object.values(row).some(value => value && value.trim() !== '')
            );

            if (filteredData.length === 0) {
                return {
                    isValid: false,
                    message: 'CSVファイルにデータが含まれていません。'
                };
            }

            if (filteredData.length > 5) {
                filteredData.splice(5); // 5名に制限
            }

            // 必須フィールドチェック
            const headers = Object.keys(filteredData[0] || {});
            const missingRequiredFields = requiredFields.filter(field => !headers.includes(field));
            
            if (missingRequiredFields.length > 0) {
                return {
                    isValid: false,
                    message: `必須項目が不足しています：${missingRequiredFields.join('、')}`
                };
            }

            // データ内容チェック
            const validationErrors = [];
            filteredData.forEach((row, index) => {
                const rowNum = index + 1;
                
                // 必須フィールドの空値チェック
                requiredFields.forEach(field => {
                    if (!row[field] || row[field].trim() === '') {
                        validationErrors.push(`${rowNum}行目：${field}が入力されていません`);
                    }
                });

                // 年齢の数値チェック
                if (row['年齢'] && isNaN(row['年齢'])) {
                    validationErrors.push(`${rowNum}行目：年齢は数値で入力してください`);
                }

                // 名前の重複チェック
                const duplicateName = filteredData.find((otherRow, otherIndex) => 
                    otherIndex !== index && otherRow['名前'] === row['名前']
                );
                if (duplicateName) {
                    validationErrors.push(`${rowNum}行目：名前「${row['名前']}」が重複しています`);
                }
            });

            if (validationErrors.length > 0) {
                return {
                    isValid: false,
                    message: 'データに問題があります：\n' + validationErrors.slice(0, 3).join('\n') + 
                            (validationErrors.length > 3 ? `\n...他${validationErrors.length - 3}件` : '')
                };
            }

            return {
                isValid: true,
                personas: filteredData
            };
        }

        function displayPersonas() {
            const personaSection = document.getElementById('personaSection');
            const personaList = document.getElementById('personaList');
            
            if (personas.length > 0) {
                personaSection.classList.remove('hidden');
                personaList.innerHTML = '';
                
                personas.forEach((persona, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg cursor-pointer transition-colors border-gray-200 hover:border-gray-300';
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium">${persona.名前 || `ペルソナ${index + 1}`}</h3>
                                <p class="text-sm text-gray-600">
                                    ${persona.年齢 || ''}${persona.年齢 ? '歳' : ''} ${persona.年齢 && persona.学部学科 ? '|' : ''} ${persona.学部学科 || ''}
                                </p>
                            </div>
                            <span class="w-5 h-5 text-blue-600 hidden">✓</span>
                        </div>
                    `;
                    div.addEventListener('click', () => togglePersonaSelection(index, div));
                    personaList.appendChild(div);
                });
            }
        }

        function togglePersonaSelection(index, element) {
            const checkIcon = element.querySelector('span:last-child');
            
            if (selectedPersonas.includes(index)) {
                selectedPersonas = selectedPersonas.filter(i => i !== index);
                element.classList.remove('border-blue-500', 'bg-blue-50');
                element.classList.add('border-gray-200');
                checkIcon.classList.add('hidden');
            } else {
                selectedPersonas.push(index);
                element.classList.add('border-blue-500', 'bg-blue-50');
                element.classList.remove('border-gray-200');
                checkIcon.classList.remove('hidden');
            }
            
            updateStatus();
        }

        function selectFramework(frameworkId, element) {
            // 他の選択を解除
            document.querySelectorAll('#frameworkList > div').forEach(div => {
                div.classList.remove('border-orange-500', 'bg-orange-50');
                div.classList.add('border-gray-200');
                div.querySelector('span:last-child').classList.add('hidden');
            });
            
            // カスタムフレームワーク入力エリアを非表示にする
            const customArea = document.getElementById('customFrameworkArea');
            if (customArea) {
                customArea.classList.add('hidden');
            }
            
            // 新しい選択を適用
            selectedFramework = frameworkId;
            element.classList.add('border-orange-500', 'bg-orange-50');
            element.classList.remove('border-gray-200');
            element.querySelector('span:last-child').classList.remove('hidden');
            
            // カスタムフレームワークの場合は入力エリアを表示
            if (frameworkId === 'custom') {
                if (customArea) {
                    customArea.classList.remove('hidden');
                }
                frameworkSelectionReason = 'ユーザー独自のフレームワーク・手法を使用';
            } else {
                // 選択理由を記録（推奨かどうかで理由を自動生成）
                const finalChallenge = selectedChallenge === 'custom' ? customChallengeText.trim() : selectedChallenge;
                const recommended = getRecommendedFrameworks(finalChallenge);
                const framework = frameworks.find(f => f.id === frameworkId);
                
                if (recommended.includes(frameworkId)) {
                    frameworkSelectionReason = `課題「${finalChallenge}」に対する推奨フレームワークとして選択。${framework.autonomyRationale}`;
                } else {
                    frameworkSelectionReason = `ユーザー独自の判断により選択。${framework.autonomyRationale}`;
                }
            }
            
            updateStatus();
        }

        function selectAllPersonas() {
            selectedPersonas = [];
            for (let i = 0; i < personas.length; i++) {
                selectedPersonas.push(i);
            }
            
            // 全てのペルソナ要素の見た目を更新
            document.querySelectorAll('#personaList > div').forEach((element, index) => {
                const checkIcon = element.querySelector('span:last-child');
                element.classList.add('border-blue-500', 'bg-blue-50');
                element.classList.remove('border-gray-200');
                checkIcon.classList.remove('hidden');
            });
            
            updateStatus();
        }

        function clearAllPersonas() {
            selectedPersonas = [];
            
            // 全てのペルソナ要素の見た目を更新
            document.querySelectorAll('#personaList > div').forEach(element => {
                const checkIcon = element.querySelector('span:last-child');
                element.classList.remove('border-blue-500', 'bg-blue-50');
                element.classList.add('border-gray-200');
                checkIcon.classList.add('hidden');
            });
            
            updateStatus();
        }

        function updateStatus() {
            // ペルソナファイル状況
            const personaStatus = document.getElementById('personaStatus');
            const personaStatusText = document.getElementById('personaStatusText');
            if (personas.length > 0) {
                personaStatus.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                personaStatusText.textContent = `ペルソナファイル: ${personas.length}名読み込み済み`;
            } else {
                personaStatus.className = 'w-3 h-3 rounded-full mr-2 bg-gray-300';
                personaStatusText.textContent = 'ペルソナファイル: 未読み込み';
            }

            // 選択ペルソナ状況
            const selectedStatus = document.getElementById('selectedStatus');
            const selectedStatusText = document.getElementById('selectedStatusText');
            if (selectedPersonas.length > 0) {
                selectedStatus.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                selectedStatusText.textContent = `選択ペルソナ: ${selectedPersonas.length}名`;
            } else {
                selectedStatus.className = 'w-3 h-3 rounded-full mr-2 bg-gray-300';
                selectedStatusText.textContent = '選択ペルソナ: 0名';
            }

            // 選択数表示の更新
            const selectionCount = document.getElementById('selectionCount');
            if (selectionCount) {
                selectionCount.textContent = `${selectedPersonas.length}名選択中`;
            }

            // 課題設定状況
            const challengeStatus = document.getElementById('challengeStatus');
            const challengeStatusText = document.getElementById('challengeStatusText');
            const hasChallengeSet = selectedChallenge && (selectedChallenge !== 'custom' || customChallengeText.trim());
            if (hasChallengeSet) {
                challengeStatus.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                challengeStatusText.textContent = '課題設定: 設定済み';
            } else {
                challengeStatus.className = 'w-3 h-3 rounded-full mr-2 bg-gray-300';
                challengeStatusText.textContent = '課題設定: 未設定';
            }

            // フレームワーク状況
            const frameworkStatus = document.getElementById('frameworkStatus');
            const frameworkStatusText = document.getElementById('frameworkStatusText');
            const hasFrameworkSet = selectedFramework && (selectedFramework !== 'custom' || customFrameworkText.trim());
            if (hasFrameworkSet) {
                frameworkStatus.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                if (selectedFramework === 'custom') {
                    frameworkStatusText.textContent = 'フレームワーク: カスタム設定済み';
                } else {
                    const framework = frameworks.find(f => f.id === selectedFramework);
                    frameworkStatusText.textContent = `フレームワーク: ${framework.name}`;
                }
            } else {
                frameworkStatus.className = 'w-3 h-3 rounded-full mr-2 bg-gray-300';
                frameworkStatusText.textContent = 'フレームワーク: 未選択';
            }

            // プレビュー・生成ボタンの有効/無効
            const previewBtn = document.getElementById('previewBtn');
            const generateBtn = document.getElementById('generateBtn');
            const canGenerate = selectedPersonas.length > 0 && hasChallengeSet && hasFrameworkSet;
            
            previewBtn.disabled = !canGenerate;
            generateBtn.disabled = !canGenerate;

            // プログレスバーの更新
            updateProgressBar();
            
            // フレームワーク推奨の更新
            updateFrameworkRecommendations();
            
            // 設定の自動保存
            saveSettings();
        }

        function updateProgressBar() {
            const step1Complete = personas.length > 0 && selectedPersonas.length > 0;
            const step2Complete = selectedChallenge && (selectedChallenge !== 'custom' || customChallengeText.trim());
            const step3Complete = selectedFramework && (selectedFramework !== 'custom' || customFrameworkText.trim());
            const step4Complete = step1Complete && step2Complete && step3Complete;

            // ステップ1: ペルソナ読み込み・選択
            updateStepStatus(1, step1Complete, personas.length > 0 ? 50 : 0, selectedPersonas.length > 0 ? 100 : (personas.length > 0 ? 50 : 0));
            
            // ステップ2: 課題設定
            updateStepStatus(2, step2Complete, 0, step2Complete ? 100 : 0);
            
            // ステップ3: フレームワーク選択
            updateStepStatus(3, step3Complete, 0, step3Complete ? 100 : 0);
            
            // ステップ4: 生成準備完了
            updateStepStatus(4, step4Complete, 0, step4Complete ? 100 : 0);

            // 全体の進捗パーセンテージ
            const completedSteps = [step1Complete, step2Complete, step3Complete, step4Complete].filter(Boolean).length;
            const overallProgress = Math.round((completedSteps / 4) * 100);
            
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${overallProgress}% 完了`;
            }
        }

        function updateStepStatus(stepNumber, isComplete, partialProgress, fullProgress) {
            const stepIcon = document.getElementById(`step${stepNumber}Icon`);
            const progressBar = document.querySelector(`#progress${stepNumber} > div`);
            
            if (isComplete) {
                // 完了状態
                stepIcon.className = 'w-8 h-8 rounded-full border-2 border-green-500 bg-green-500 flex items-center justify-center mr-2 transition-colors';
                stepIcon.innerHTML = '<span class="text-xs text-white">✓</span>';
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.className = 'h-full bg-green-500 rounded-full transition-all duration-300';
                }
            } else if (fullProgress > 0) {
                // 進行中状態
                stepIcon.className = 'w-8 h-8 rounded-full border-2 border-blue-500 bg-blue-100 flex items-center justify-center mr-2 transition-colors';
                stepIcon.innerHTML = `<span class="text-xs font-semibold text-blue-600">${stepNumber}</span>`;
                if (progressBar) {
                    progressBar.style.width = `${fullProgress}%`;
                    progressBar.className = 'h-full bg-blue-500 rounded-full transition-all duration-300';
                }
            } else {
                // 未完了状態
                stepIcon.className = 'w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center mr-2 transition-colors';
                stepIcon.innerHTML = `<span class="text-xs font-semibold text-gray-500">${stepNumber}</span>`;
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.className = 'h-full bg-blue-500 rounded-full transition-all duration-300';
                }
            }
        }

        function generatePrompt() {
            const hasFrameworkSet = selectedFramework && (selectedFramework !== 'custom' || customFrameworkText.trim());
            if (selectedPersonas.length === 0 || !selectedChallenge || !hasFrameworkSet) {
                alert('ペルソナ、課題、フレームワークを全て選択してください。');
                return;
            }

            const selectedPersonaData = selectedPersonas.map(index => personas[index]);
            const finalChallenge = selectedChallenge === 'custom' ? customChallengeText : selectedChallenge;
            
            let selectedFrameworkData;
            let frameworkName;
            let frameworkDescription;
            
            if (selectedFramework === 'custom') {
                frameworkName = 'カスタムフレームワーク';
                frameworkDescription = customFrameworkText.trim();
                selectedFrameworkData = { name: frameworkName, description: frameworkDescription };
            } else {
                selectedFrameworkData = frameworks.find(f => f.id === selectedFramework);
                frameworkName = selectedFrameworkData.name;
                frameworkDescription = selectedFrameworkData.description;
            }

            const personaSection = selectedPersonaData.map((persona, index) => `
**ペルソナ${index + 1}: ${persona.名前 || `ペルソナ${index + 1}`}**
- 年齢: ${persona.年齢 || ''}
- 学部学科: ${persona.学部学科 || ''}
- 出身地: ${persona.出身地 || ''}
- 居住形態: ${persona.居住形態 || ''}
- 経済状況: ${persona.経済状況 || ''}
- 性格特性: ${persona.性格特性 || ''}
- 価値観: ${persona.価値観 || ''}
- 学習姿勢: ${persona.学習姿勢 || ''}
- 人間関係: ${persona.人間関係 || ''}
- 主な課題: ${persona.主な課題 || ''}
- 成長の兆し: ${persona.成長の兆し || ''}
- 特徴的エピソード: ${persona.特徴的エピソード || ''}
- 支援アプローチ: ${persona.支援アプローチ || ''}`).join('\n');

            const prompt = `# 学生のセルフ・オーサーシップを重視した${frameworkName}

## 【役割設定】
あなたは学生のセルフ・オーサーシップを重視する教育関係者です。

## 【セルフ・オーサーシップの定義と重要性】
学生のセルフ・オーサーシップとは、学生が自分の学習・成長の主体者として意思決定し、行動する能力を指します。以下の観点を最重要視してください：

- **自律性**: 学生が自ら選択し、決定する権利と能力
- **主体性**: 学生が能動的に学習・成長に取り組む姿勢
- **自己決定権**: 学生自身の価値観・目標に基づく選択の尊重
- **エンパワーメント**: 学生の成長の可能性を信頼し、支援する視点

## 【学生ペルソナ情報】
${personaSection}

## 【取り組む課題・疑問】
${finalChallenge}

## 【適用フレームワーク: ${frameworkName}】
${frameworkDescription}

## 【実行指示】
上記の学生ペルソナを対象に、「${finalChallenge}」という課題について${frameworkName}を実施してください。

**重要な前提条件：**
1. 学生のセルフ・オーサーシップを最優先に考慮すること
2. 学生の自律性と主体性を支援・促進する視点で分析すること
3. 学生自身の価値観・目標・選択を尊重すること
4. 上から目線の解決策ではなく、学生の内在的動機が高まるアプローチを重視すること

## 【期待される出力】
- 各ペルソナの視点からの詳細な分析
- セルフ・オーサーシップの観点からの課題理解
- 学生の主体性を促進する具体的なアプローチ提案
- 実装可能で実践的な改善案

分析結果を、構造化された形式で、具体例を交えながら提示してください。`;

            document.getElementById('generatedPrompt').textContent = prompt;
            document.getElementById('promptSection').classList.remove('hidden');
        }

        function copyPrompt() {
            const prompt = document.getElementById('generatedPrompt').textContent;
            navigator.clipboard.writeText(prompt).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                copyBtn.innerHTML = '<span class="mr-2">✓</span>コピー済み';
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<span class="mr-2">📋</span>コピー';
                }, 2000);
            }).catch(() => {
                alert('コピーに失敗しました。手動でコピーしてください。');
            });
        }

        function jumpToStep(stepNumber) {
            let targetElement;
            
            switch(stepNumber) {
                case 1:
                    // ペルソナセクションにジャンプ
                    targetElement = document.getElementById('csvFile');
                    if (personas.length === 0) {
                        // CSVアップロードにフォーカス
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetElement.focus();
                    } else {
                        // ペルソナ選択セクションにジャンプ
                        targetElement = document.getElementById('personaSection');
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    break;
                    
                case 2:
                    // 課題設定セクションにジャンプ
                    targetElement = document.querySelector('[name="challenge"]');
                    if (targetElement) {
                        targetElement.closest('.bg-white').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    break;
                    
                case 3:
                    // フレームワーク選択セクションにジャンプ
                    targetElement = document.getElementById('frameworkList');
                    if (targetElement) {
                        targetElement.closest('.bg-white').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    break;
                    
                case 4:
                    // プロンプト生成ボタンにジャンプ
                    targetElement = document.getElementById('generateBtn');
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // 全ての条件が揃っている場合はボタンを強調
                        if (!targetElement.disabled) {
                            targetElement.classList.add('animate-pulse');
                            setTimeout(() => {
                                targetElement.classList.remove('animate-pulse');
                            }, 3000);
                        }
                    }
                    break;
            }
        }

        function toggleExplanation() {
            const content = document.getElementById('explanationContent');
            const icon = document.getElementById('explanationIcon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function showTooltip(type) {
            let message = '';
            
            switch(type) {
                case 'persona-help':
                    message = 'セルフ・オーサーシップ重視：各ペルソナの「自律性・主体性・自己決定権」を出発点として分析を行います。ペルソナを「問題を抱える対象」ではなく「成長の主体者」として捉え、内在的な力と可能性に焦点を当てます。';
                    break;
                case 'challenge-help':
                    message = '従来の「問題解決型」ではなく「成長支援型」の課題設定：学生の自律性を制限せず、むしろ促進するような支援方法を見つけることに重点を置きます。';
                    break;
                case 'framework-help':
                    message = 'セルフ・オーサーシップの観点：各フレームワークは学生の内発的動機と自己決定能力を高めることを目的とします。分析結果は学生の価値観・目標を起点とした支援策につながります。';
                    break;
            }
            
            alert(message);
        }

        // エラーメッセージ表示関数
        function showErrorMessage(elementId, message) {
            const errorElement = document.getElementById(elementId);
            const messageElement = document.getElementById(elementId + '-message');
            if (errorElement && messageElement) {
                messageElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        function clearErrorMessage(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }

        // 成功メッセージ表示関数
        function showSuccessMessage(elementId, message) {
            const successElement = document.getElementById(elementId);
            const messageElement = document.getElementById(elementId + '-message');
            if (successElement && messageElement) {
                messageElement.textContent = message;
                successElement.classList.remove('hidden');
            }
        }

        function clearSuccessMessage(elementId) {
            const successElement = document.getElementById(elementId);
            if (successElement) {
                successElement.classList.add('hidden');
            }
        }

        // 読み込み中メッセージ表示関数
        function showLoadingMessage(elementId, message) {
            const loadingElement = document.getElementById(elementId);
            const messageElement = document.getElementById(elementId + '-message');
            if (loadingElement && messageElement) {
                messageElement.textContent = message;
                loadingElement.classList.remove('hidden');
            }
        }

        function clearLoadingMessage(elementId) {
            const loadingElement = document.getElementById(elementId);
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }

        // カスタム課題検証
        function validateCustomChallenge(text) {
            clearErrorMessage('challenge-error');
            clearSuccessMessage('challenge-success');

            if (!text || text.trim().length === 0) {
                return;
            }

            const trimmedText = text.trim();
            
            if (trimmedText.length < 10) {
                showErrorMessage('challenge-error', '課題は10文字以上で入力してください。より具体的な課題設定をお願いします。');
                return;
            }

            if (trimmedText.length > 500) {
                showErrorMessage('challenge-error', '課題は500文字以内で入力してください。');
                return;
            }

            // 質問形式チェック（推奨）
            const hasQuestionMark = trimmedText.includes('？') || trimmedText.includes('?');
            const hasQuestionWords = /どのよう|どうす|なぜ|どうして|いかに|どんな|何を|どこで|いつ|誰が/.test(trimmedText);
            
            if (!hasQuestionMark && !hasQuestionWords) {
                showSuccessMessage('challenge-success', '課題が設定されました。より具体的な疑問形式（？）で記述すると、より良い分析結果が得られます。');
                return;
            }

            showSuccessMessage('challenge-success', '適切な課題設定です。セルフ・オーサーシップの観点で分析されます。');
        }

        // 文字数カウンター更新
        function updateCharacterCounter() {
            const textArea = document.getElementById('customChallengeText');
            const counter = document.getElementById('customChallengeCounter');
            
            if (textArea && counter) {
                const currentLength = textArea.value.length;
                counter.textContent = `${currentLength}/500`;
                
                if (currentLength > 450) {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-red-500 font-medium';
                } else if (currentLength > 400) {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-yellow-600';
                } else {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-gray-400';
                }
            }
        }

        // カスタムフレームワーク文字数カウンター更新
        function updateCustomFrameworkCounter() {
            const textArea = document.getElementById('customFrameworkText');
            const counter = document.getElementById('customFrameworkCounter');
            
            if (textArea && counter) {
                const currentLength = textArea.value.length;
                counter.textContent = `${currentLength}/300`;
                
                if (currentLength > 270) {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-red-500 font-medium';
                } else if (currentLength > 240) {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-yellow-600';
                } else {
                    counter.className = 'absolute bottom-2 right-2 text-xs text-gray-400';
                }
                
                // グローバル変数を更新
                customFrameworkText = textArea.value;
            }
        }

        // カスタムフレームワーク検証
        function validateCustomFramework(text) {
            clearErrorMessage('framework-error');
            clearSuccessMessage('framework-success');

            if (!text || text.trim().length === 0) {
                return;
            }

            const trimmedText = text.trim();
            
            if (trimmedText.length < 10) {
                showErrorMessage('framework-error', 'フレームワークは10文字以上で入力してください。より具体的な手法を記述してください。');
                return;
            }

            if (trimmedText.length > 300) {
                showErrorMessage('framework-error', 'フレームワークは300文字以内で入力してください。');
                return;
            }

            showSuccessMessage('framework-success', 'カスタムフレームワークが設定されました。セルフ・オーサーシップの観点で活用されます。');
        }

        // LocalStorage設定保存・復元機能
        const STORAGE_KEY = 'persona_prompt_tool_settings';

        function saveSettings() {
            try {
                const settings = {
                    personas: personas,
                    selectedPersonas: selectedPersonas,
                    selectedChallenge: selectedChallenge,
                    customChallengeText: customChallengeText,
                    selectedFramework: selectedFramework,
                    customFrameworkText: customFrameworkText,
                    frameworkSelectionReason: frameworkSelectionReason,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                updateSaveStatus('saved');
                
                // 5分後に未保存状態に戻す（変更があったことを示すため）
                setTimeout(() => {
                    updateSaveStatus('idle');
                }, 300000);
                
            } catch (error) {
                console.warn('設定の保存に失敗しました:', error);
                updateSaveStatus('error');
            }
        }

        function restoreSettings() {
            try {
                const savedSettings = localStorage.getItem(STORAGE_KEY);
                if (!savedSettings) {
                    updateSaveStatus('idle');
                    return;
                }

                const settings = JSON.parse(savedSettings);
                
                // 24時間以上古い設定は削除
                if (settings.timestamp && (Date.now() - settings.timestamp) > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(STORAGE_KEY);
                    updateSaveStatus('idle');
                    return;
                }

                // ペルソナデータの復元
                if (settings.personas && Array.isArray(settings.personas) && settings.personas.length > 0) {
                    personas = settings.personas;
                    selectedPersonas = settings.selectedPersonas || [];
                    displayPersonas();
                }

                // 課題設定の復元
                if (settings.selectedChallenge) {
                    selectedChallenge = settings.selectedChallenge;
                    customChallengeText = settings.customChallengeText || '';
                    
                    // ラジオボタンの選択状態復元
                    const challengeRadio = document.querySelector(`input[name="challenge"][value="${selectedChallenge}"]`);
                    if (challengeRadio) {
                        challengeRadio.checked = true;
                        if (selectedChallenge === 'custom') {
                            const customTextArea = document.getElementById('customChallengeText');
                            const customCounter = document.getElementById('customChallengeCounter');
                            customTextArea.classList.remove('hidden');
                            customCounter.classList.remove('hidden');
                            customTextArea.value = customChallengeText;
                            updateCharacterCounter();
                            validateCustomChallenge(customChallengeText);
                        }
                    }
                }

                // フレームワーク選択の復元
                if (settings.selectedFramework) {
                    selectedFramework = settings.selectedFramework;
                    customFrameworkText = settings.customFrameworkText || '';
                    frameworkSelectionReason = settings.frameworkSelectionReason || '';
                    
                    // フレームワーク選択UIの復元
                    setTimeout(() => {
                        const frameworkElements = document.querySelectorAll('#frameworkList > div');
                        frameworkElements.forEach((element, index) => {
                            const isCustom = selectedFramework === 'custom' && index === frameworkElements.length - 1;
                            const isPreset = frameworks[index] && frameworks[index].id === selectedFramework;
                            
                            if (isCustom || isPreset) {
                                element.classList.add('border-orange-500', 'bg-orange-50');
                                element.classList.remove('border-gray-200');
                                element.querySelector('span:last-child').classList.remove('hidden');
                                
                                // カスタムフレームワークの場合は入力エリアも表示
                                if (isCustom) {
                                    const customArea = document.getElementById('customFrameworkArea');
                                    const customTextArea = document.getElementById('customFrameworkText');
                                    if (customArea && customTextArea) {
                                        customArea.classList.remove('hidden');
                                        customTextArea.value = customFrameworkText;
                                        updateCustomFrameworkCounter();
                                        validateCustomFramework(customFrameworkText);
                                    }
                                }
                            }
                        });
                    }, 100);
                }

                updateStatus();
                updateSaveStatus('restored');
                
                // 復元メッセージを3秒後に消す
                setTimeout(() => {
                    updateSaveStatus('idle');
                }, 3000);

            } catch (error) {
                console.warn('設定の復元に失敗しました:', error);
                localStorage.removeItem(STORAGE_KEY);
                updateSaveStatus('error');
            }
        }

        function clearAllSettings() {
            if (confirm('全ての設定をクリアしますか？\n（ペルソナデータ、課題設定、フレームワーク選択がリセットされます）')) {
                // LocalStorage削除
                localStorage.removeItem(STORAGE_KEY);
                
                // 変数リセット
                personas = [];
                selectedPersonas = [];
                selectedChallenge = '';
                customChallengeText = '';
                selectedFramework = '';
                customFrameworkText = '';
                frameworkSelectionReason = '';
                
                // UI リセット
                document.getElementById('csvFile').value = '';
                document.getElementById('personaSection').classList.add('hidden');
                document.querySelectorAll('input[name="challenge"]').forEach(radio => radio.checked = false);
                document.getElementById('customChallengeText').classList.add('hidden');
                document.getElementById('customChallengeCounter').classList.add('hidden');
                document.getElementById('customChallengeText').value = '';
                
                // フレームワーク選択解除
                document.querySelectorAll('#frameworkList > div').forEach(div => {
                    div.classList.remove('border-orange-500', 'bg-orange-50');
                    div.classList.add('border-gray-200');
                    div.querySelector('span:last-child').classList.add('hidden');
                });
                
                // カスタムフレームワーク入力エリアを非表示にしてクリア
                const customFrameworkArea = document.getElementById('customFrameworkArea');
                const customFrameworkTextArea = document.getElementById('customFrameworkText');
                if (customFrameworkArea && customFrameworkTextArea) {
                    customFrameworkArea.classList.add('hidden');
                    customFrameworkTextArea.value = '';
                }
                
                // エラーメッセージクリア
                clearErrorMessage('csv-error');
                clearSuccessMessage('csv-success');
                clearErrorMessage('challenge-error');
                clearSuccessMessage('challenge-success');
                clearErrorMessage('framework-error');
                clearSuccessMessage('framework-success');
                
                // 生成されたプロンプト隠す
                document.getElementById('promptSection').classList.add('hidden');
                
                updateStatus();
                updateSaveStatus('cleared');
                
                setTimeout(() => {
                    updateSaveStatus('idle');
                }, 2000);
            }
        }

        function updateSaveStatus(status) {
            const statusDot = document.getElementById('saveStatus');
            const statusText = document.getElementById('saveStatusText');
            
            if (!statusDot || !statusText) return;
            
            switch(status) {
                case 'saved':
                    statusDot.className = 'w-2 h-2 rounded-full mr-1 bg-green-500';
                    statusText.textContent = '保存済み';
                    statusText.className = 'text-xs text-green-600';
                    break;
                case 'restored':
                    statusDot.className = 'w-2 h-2 rounded-full mr-1 bg-blue-500';
                    statusText.textContent = '復元済み';
                    statusText.className = 'text-xs text-blue-600';
                    break;
                case 'cleared':
                    statusDot.className = 'w-2 h-2 rounded-full mr-1 bg-orange-500';
                    statusText.textContent = 'クリア済み';
                    statusText.className = 'text-xs text-orange-600';
                    break;
                case 'error':
                    statusDot.className = 'w-2 h-2 rounded-full mr-1 bg-red-500';
                    statusText.textContent = 'エラー';
                    statusText.className = 'text-xs text-red-600';
                    break;
                default: // 'idle'
                    statusDot.className = 'w-2 h-2 rounded-full mr-1 bg-gray-300';
                    statusText.textContent = '待機中';
                    statusText.className = 'text-xs text-gray-500';
                    break;
            }
        }

        // プレビュー機能
        function showPreview() {
            const hasFrameworkSet = selectedFramework && (selectedFramework !== 'custom' || customFrameworkText.trim());
            if (selectedPersonas.length === 0 || !selectedChallenge || !hasFrameworkSet) {
                alert('ペルソナ、課題、フレームワークを全て選択してください。');
                return;
            }

            // プレビューデータを構築
            populatePreviewData();
            
            // モーダルを表示
            document.getElementById('previewModal').classList.remove('hidden');
            
            // エシカルチェックのイベントリスナーを設定
            setTimeout(() => {
                setupEthicsCheckListeners();
                updateEthicsButtonState();
            }, 100);
            
            // スクロールを最上部に
            document.querySelector('#previewModal .overflow-y-auto').scrollTop = 0;
        }

        function populatePreviewData() {
            // ペルソナ情報
            const previewPersonas = document.getElementById('previewPersonas');
            const selectedPersonaData = selectedPersonas.map(index => personas[index]);
            
            previewPersonas.innerHTML = selectedPersonaData.map(persona => `
                <div class="flex items-center justify-between bg-white rounded p-2 border border-green-300">
                    <div>
                        <div class="font-medium text-green-800">${persona.名前 || 'ペルソナ名未設定'}</div>
                        <div class="text-xs text-green-600">${persona.年齢 || ''}${persona.年齢 ? '歳' : ''} ${persona.学部学科 || ''}</div>
                    </div>
                    <span class="text-green-600">✓</span>
                </div>
            `).join('');

            // 課題設定
            const previewChallenge = document.getElementById('previewChallenge');
            const finalChallenge = selectedChallenge === 'custom' ? customChallengeText : selectedChallenge;
            previewChallenge.innerHTML = `
                <div class="bg-white rounded p-2 border border-purple-300">
                    <div class="font-medium text-purple-800 mb-1">${selectedChallenge === 'custom' ? 'カスタム課題' : '選択課題'}</div>
                    <div class="text-sm text-purple-700">"${finalChallenge}"</div>
                    ${finalChallenge.length > 50 ? `<div class="text-xs text-purple-600 mt-1">${finalChallenge.length}文字</div>` : ''}
                </div>
            `;

            // フレームワーク
            const previewFramework = document.getElementById('previewFramework');
            let frameworkDisplayData;
            
            if (selectedFramework === 'custom') {
                frameworkDisplayData = {
                    name: 'カスタムフレームワーク',
                    description: customFrameworkText.trim()
                };
            } else {
                frameworkDisplayData = frameworks.find(f => f.id === selectedFramework);
            }
            
            previewFramework.innerHTML = `
                <div class="bg-white rounded p-2 border border-orange-300">
                    <div class="font-medium text-orange-800 mb-1">${frameworkDisplayData.name}</div>
                    <div class="text-xs text-orange-600">${frameworkDisplayData.description}</div>
                </div>
            `;

            // プロンプト構造
            const previewPromptStructure = document.getElementById('previewPromptStructure');
            previewPromptStructure.innerHTML = `
                <div class="space-y-2">
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                        <span class="font-medium">セルフ・オーサーシップ重視の役割設定</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                        <span>学生ペルソナ詳細情報（${selectedPersonas.length}名分）</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                        <span>取り組む課題・疑問の明確化</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                        <span>${frameworkDisplayData.name}の実行指示</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                        <span>期待される分析結果・出力形式の指定</span>
                    </div>
                </div>
                
                <div class="mt-3 p-2 bg-blue-100 rounded text-xs text-blue-800">
                    <strong>推定文字数:</strong> 約${Math.round((selectedPersonaData.length * 150 + finalChallenge.length + 800) / 100) * 100}文字
                </div>
            `;
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function confirmAndGenerate() {
            const allChecked = checkAllEthicsItems();
            if (!allChecked) {
                alert('AI使用時の注意点全ての確認項目にチェックを入れてください。');
                return;
            }
            
            closePreview();
            generatePrompt();
        }

        function toggleEthicsPanel() {
            const details = document.getElementById('ethicsDetails');
            const toggle = document.getElementById('ethicsToggle');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                toggle.innerHTML = '詳細を非表示 ▲';
            } else {
                details.classList.add('hidden');
                toggle.innerHTML = '詳細を表示 ▼';
            }
        }

        function checkAllEthicsItems() {
            const checks = ['ethicsCheck1', 'ethicsCheck2', 'ethicsCheck3', 'ethicsCheck4'];
            return checks.every(id => document.getElementById(id)?.checked);
        }

        function updateEthicsButtonState() {
            const confirmBtn = document.getElementById('confirmGenerateBtn');
            const allChecked = checkAllEthicsItems();
            
            if (allChecked) {
                confirmBtn.disabled = false;
                confirmBtn.className = 'px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium';
                confirmBtn.textContent = 'この内容でプロンプト生成';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.className = 'px-6 py-2 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed';
                confirmBtn.textContent = '注意点確認後に生成可能';
            }
        }

        function setupEthicsCheckListeners() {
            const checks = ['ethicsCheck1', 'ethicsCheck2', 'ethicsCheck3', 'ethicsCheck4'];
            checks.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', updateEthicsButtonState);
                }
            });
        }

        // 活用ガイドトグル機能
        function toggleUsageGuide(type) {
            const content = document.getElementById(`${type}Content`);
            const icon = document.getElementById(`${type}Icon`);
            
            if (content && icon) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // 独立パネルトグル機能
        function toggleStandalonePanel(type) {
            const content = document.getElementById(`standalone${type === 'ethics' ? 'Ethics' : 'Usage'}Content`);
            const icon = document.getElementById(`standalone${type === 'ethics' ? 'Ethics' : 'Usage'}Icon`);
            
            if (content && icon) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // フレームワーク詳細表示トグル機能
        function toggleFrameworkDetails(frameworkId) {
            const details = document.getElementById(`details_${frameworkId}`);
            const toggle = document.getElementById(`toggle_${frameworkId}`);
            
            if (details && toggle) {
                if (details.classList.contains('hidden')) {
                    details.classList.remove('hidden');
                    toggle.textContent = '詳細を非表示 ▲';
                } else {
                    details.classList.add('hidden');
                    toggle.textContent = '詳細を表示 ▼';
                }
            }
        }

        // 課題に基づくフレームワーク推奨機能
        function getRecommendedFrameworks(challenge) {
            if (!challenge) return [];
            
            const recommendationMap = {
                // 学習効果向上系
                '学習モチベーション向上': ['empathy_map', 'persona_interview'],
                '授業理解度・満足度向上': ['student_journey', 'service_blueprint'],
                '学習習慣・時間管理改善': ['student_journey', 'empathy_map'],
                'デジタル学習環境最適化': ['service_blueprint', 'ecosystem_map'],
                'アクティブラーニング促進': ['persona_discussion', 'ecosystem_map'],
                '個別学習支援': ['persona_interview', 'empathy_map'],
                
                // 学生生活支援系
                'キャリア支援・就職活動支援': ['persona_interview', 'student_journey'],
                'ウェルビーイング向上': ['empathy_map', 'ecosystem_map'],
                '学生コミュニティ形成': ['persona_discussion', 'ecosystem_map'],
                '経済的支援制度改善': ['service_blueprint', 'ecosystem_map'],
                '大学生活適応支援': ['student_journey', 'persona_discussion'],
                '進路選択支援': ['student_journey', 'persona_interview']
            };
            
            return recommendationMap[challenge] || [];
        }

        // 推奨フレームワークの表示更新
        function updateFrameworkRecommendations() {
            const finalChallenge = selectedChallenge === 'custom' ? customChallengeText.trim() : selectedChallenge;
            if (!finalChallenge) return;
            
            const recommended = getRecommendedFrameworks(finalChallenge);
            
            // 全フレームワークの推奨表示をリセット
            frameworks.forEach(fw => {
                const element = document.querySelector(`#frameworkList [onclick*="${fw.id}"]`);
                if (element) {
                    const parent = element.closest('.border');
                    parent.classList.remove('border-green-300', 'bg-green-50');
                    
                    // 既存の推奨バッジを削除
                    const existingBadge = parent.querySelector('.recommended-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                }
            });
            
            // 推奨フレームワークにバッジを追加
            recommended.forEach(frameworkId => {
                const element = document.querySelector(`#frameworkList [onclick*="${frameworkId}"]`);
                if (element) {
                    const parent = element.closest('.border');
                    parent.classList.add('border-green-300', 'bg-green-50');
                    
                    // 推奨バッジを追加
                    const badge = document.createElement('div');
                    badge.className = 'recommended-badge absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full';
                    badge.textContent = '推奨';
                    parent.style.position = 'relative';
                    parent.appendChild(badge);
                }
            });
        }
    </script>
</body>
</html>
